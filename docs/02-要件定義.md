# 画像配布サービス 要件定義書

## 1. はじめに
本ドキュメントは、Supabase＋Edge Functionを用いた画像配布サービス（以下「本サービス」）の要件定義書です。
ユーザー要望をもとに、機能要件・非機能要件を整理し、初期バージョンでのスコープを明確化します。

## 2. 対象範囲
- 画像形式：PNG／JPEG  
- 認証：管理者が会員情報を登録し、会員のみがダウンロード可能  
- ウォーターマーク：会員ID（例 `user001`）を斜め45°で全体に埋め込む  
- ダウンロード：共有リンク不可。エンドポイント経由でのみ配信  
- ストレージ：Supabase Storage（バケット無制限保存）  
- Edge Function：Deno＋ImageScriptで動的にウォーターマーク生成  

## 3. 用語定義
| 用語           | 意味                                        |
|-------------|-------------------------------------------|
| 会員ID        | 人が識別しやすい文字列。例：`user001`               |
| オリジナル画像    | ユーザーがアップロードした未加工の画像                  |
| 加工済画像      | ウォーターマークを付与した画像                       |
| ダウンロードエンドポイント | 認証済ユーザーがアクセスし、加工済画像を返却するAPIパス   |
| 監査ログ       | 誰がいつどのIPでダウンロードしたかを記録するログ           |

## 4. 機能要件

### 4.1 会員管理・認証
- 管理者のみが会員登録を実施  
- 会員テーブルに以下を保持  
  - `id` (UUID)  
  - `member_code` (例 `user001`)  
  - `email` など必要最低限の連絡先情報  
- 認証トークン：Supabase Auth の JWT をヘッダーで受信し検証  

### 4.2 画像アップロード・管理
- 管理者または管理画面からオリジナル画像をバケットにアップロード  
- 画像メタ情報テーブルに以下を保持  
  - `image_id` (UUID)  
  - `file_path`  
  - `upload_date`  
  - 必要に応じて `width`/`height` 等  

### 4.3 ウォーターマーク付与  
- Edge Function（Deno + ImageScript）で画像処理  
- 会員IDを斜め45°で、画像全体に繰り返し敷き詰め  
- 初期不透明度は固定（管理画面での設定は後段フェーズで対応）  

### 4.4 画像ダウンロードAPI  
- エンドポイント例：  
  ```http
  GET /api/v1/images/{image_id}/download
  Authorization: Bearer <JWT>
  ```  
- フロー：  
  1. JWT検証 → 会員ID取得  
  2. バケット内に加工済画像があれば返却  
  3. なければEdge Functionで生成・保存→返却  

### 4.5 監査ログ取得  
- ダウンロード成功／失敗時に以下をログテーブルへ記録  
  - `log_id`  
  - `member_code`  
  - `image_id`  
  - `timestamp`  
  - `client_ip`  

## 5. 非機能要件

| 項目           | 初期バージョンの対応                              |
|-------------|-------------------------------------------|
| パフォーマンス     | 未検討（後続フェーズで負荷要件を策定）               |
| キャッシュ       | 未検討（CDNなどは後続フェーズで設計）                 |
| 可用性/フォールバック | 未設定（Edge Function障害時の代替は後続フェーズで検討） |
| セキュリティ     | Supabase Storage の RLS を利用、JWT認証を実装         |
| モニタリング     | 未実装（ログ収集／可視化は後続フェーズで検討）         |
| バケットライフサイクル | 上限到達時に検討（自動削除・アーカイブは未設定）        |

## 6. 除外事項
- 共有リンク／プリサインドURLの発行  
- サムネイル生成・表示  
- 動的ウォーターマークパラメータ（色・フォント・角度変更）  
- レートリミット／APIバージョニング  
- GDPR等の法令対応ドキュメント  

## 7. 今後のステップ
1. **詳細設計**  
   - API仕様書（リクエスト/レスポンス例）  
   - DBスキーマ設計（会員テーブル・画像メタ・ログ）  
2. **実装フェーズ**  
   - Supabaseプロジェクト構築  
   - Edge Function開発・デプロイ  
3. **テスト・QA**  
   - ユースケース検証  
   - 監査ログ／JWT処理確認  

