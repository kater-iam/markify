# Markify 詳細設計書

## 1. アーキテクチャ概要

```
[Client] --(JWT)--> [API Gateway / EdgeFunction] --> [Supabase Auth]
                                          --> [Supabase Storage]
                                          --> [Supabase Database]
```
- クライアントは JWT を Authorization ヘッダーで送信。
- Edge Function (Deno + ImageScript) が画像生成／返却を担う。
- Supabase Storage にオリジナル・加工済画像を保存。
- Supabase Database にログ・メタ情報を保持。

---

## 2. API仕様

### 2.1 画像ダウンロード

```
GET /api/v1/images/{image_id}/download
Headers:
  Authorization: Bearer <JWT>
```  
#### リクエストパラメータ
- `image_id` (path, UUID, 必須)

#### レスポンス
| ステータス | Content-Type         | ボディ                                |
|---------|----------------------|--------------------------------------|
| 200     | `image/png` / `image/jpeg` | 画像バイナリデータ                     |
| 401     | `application/json`   | `{ "error": "Unauthorized" }`      |
| 404     | `application/json`   | `{ "error": "Not Found" }`         |
| 500     | `application/json`   | `{ "error": "Internal Server Error" }` |

---

### 2.2 画像アップロード（管理者用）

```
POST /api/v1/images
Headers:
  Authorization: Bearer <JWT-admin>
Content-Type: multipart/form-data
Body:
  file: <binary> (PNG/JPEG)
```  
#### リクエスト
- `file` (form-data, PNG/JPEG, 最大サイズ制限は別途設定)

#### レスポンス
| ステータス | Content-Type       | ボディ                                |
|---------|--------------------|--------------------------------------|
| 201     | `application/json` | `{ "image_id": "<UUID>", "file_path": "..." }` |
| 400     | `application/json` | `{ "error": "Bad Request" }`      |
| 401     | `application/json` | `{ "error": "Unauthorized" }`      |
| 500     | `application/json` | `{ "error": "Internal Server Error" }` |

---

------|--------------------|------------------------------------------------------------|
| 200     | `application/json` | `[{ "log_id": "...", "member_code": "user001", "image_id": "...", "timestamp": "...", "client_ip": "..." }, ...]` |
| 401     | `application/json` | `{ "error": "Unauthorized" }`                            |

---

## 4. 次のステップ 次のステップ
1. Supabase プロジェクトにスキーマを適用  
2. Edge Function の骨組み実装  
3. 各 API エンドポイントのユニットテスト作成  
4. 管理者用アップロード UI とログ参照 UI の実装  
5. E2E テストの実施  

以上、Markify の詳細設計案です。ご確認ください。

