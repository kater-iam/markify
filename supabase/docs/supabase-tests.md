# Supabaseテストルール

## 1. 権限管理

### 1.1 権限の定義
- 権限は `profiles` テーブルの `role` カラムで管理
- 権限の種類：
  - 管理者（admin）
  - 一般ユーザー（general）
- 詳細な権限定義は以下のドキュメントを参照：
  - `docs/03-詳細設計.md`
  - `docs/05-DB設計.md`

### 1.2 RLSポリシーのテスト方針
- サービスロールの使用は最小限（ユーザー作成のみ）に制限
- テストでは `auth.signInWithPassword` でログインしたクライアントを使用
- 各権限（admin/general）でのテストを実施
- 権限に応じたアクセス制御の検証を実施

## 2. テスト実装のルール

### 2.1 基本ルール
- テストデータは適切な権限を持つクライアントで作成
- サービスロールを使用したテストファイルは作成しない
- 管理者ユーザーのテストも `auth.signInWithPassword` を使用

### 2.2 検証項目
- 各テーブルのRLSポリシーテストで、権限ごとの操作可否を検証
- 一般ユーザーの制限された操作（更新・削除）のエラー検証
- 管理者ユーザーの全操作権限の検証

### 2.3 テストデータの作成
- テストデータは適切な権限を持つクライアントで作成
- ユーザー作成時のみサービスロールを使用可能
- テストデータは各テストケース内で作成・削除

## 3. エラー検証

### 3.1 権限エラーの検証
- 一般ユーザーによる制限された操作の実行
- 不適切な権限でのアクセス試行
- エラーメッセージの確認

### 3.2 データ整合性の検証
- 関連テーブル間のデータ整合性
- 外部キー制約の動作確認
- ユニーク制約の検証

## 4. テストの実行

### 4.1 テスト実行環境
- ローカル開発環境での実行
- CI/CD環境での実行
- テストデータのクリーンアップ

### 4.2 テストの並行実行
- テストの独立性確保
- テストデータの分離
- 並行実行時の競合回避
